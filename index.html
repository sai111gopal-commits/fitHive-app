/**
 * fit.Hive Admin Portal - Backend v8.0
 * Features: Auto-Expiry, Multi-Sheet Support, Row Locking, Photo Upload to Drive
 * @OnlyCurrentDoc false
 */

const SPREADSHEET_ID = "1iIBGAmV9ixsxs1K-O827pMiAncULk4PAxIftTQ96vMw";
const DRIVE_FOLDER_ID = "1nk5j54WwSflM01Sc-4fbfiJtk1WTSM3h";

function doGet(e) {
  const sheetName = (e && e.parameter && e.parameter.sheet) || "Regular Tracker";
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(sheetName);
  
  if (!sheet) return ContentService.createTextOutput("[]").setMimeType(ContentService.MimeType.JSON);

  // --- AUTO-EXPIRY ENGINE ---
  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues(); 
  const headers = values[0];
  const expiryIdx = headers.indexOf("Expiry Date");
  const statusIdx = headers.indexOf("Payment Status");

  if (expiryIdx !== -1 && statusIdx !== -1) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    let updatesMade = false;

    for (let i = 1; i < values.length; i++) {
      let expiryVal = values[i][expiryIdx];
      let currentStatus = values[i][statusIdx];

      if (expiryVal instanceof Date) {
        let checkDate = new Date(expiryVal);
        checkDate.setHours(0, 0, 0, 0);

        if (checkDate < today && currentStatus !== "Expired") {
          sheet.getRange(i + 1, statusIdx + 1).setValue("Expired");
          updatesMade = true;
        } else if (checkDate >= today && currentStatus === "Expired") {
          sheet.getRange(i + 1, statusIdx + 1).setValue("Paid");
          updatesMade = true;
        }
      }
    }
    if (updatesMade) SpreadsheetApp.flush();
  }

  const displayData = sheet.getDataRange().getValues();
  const rawHeaders = displayData.shift();
  
  const json = displayData.map((row, index) => {
    let obj = { rowNumber: index + 2 }; 
    rawHeaders.forEach((h, i) => {
      const key = h.toString().replace(/[^a-zA-Z0-9]/g, '');
      obj[key] = row[i];
    });
    return obj;
  });

  return ContentService.createTextOutput(JSON.stringify(json)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.tryLock(10000); 
  
  try {
    // Parse the request properly
    let params;
    
    if (e.postData && e.postData.contents) {
      try {
        params = JSON.parse(e.postData.contents);
      } catch (parseError) {
        throw new Error("Failed to parse JSON: " + parseError.toString());
      }
    } else if (e.parameter && e.parameter.action) {
      params = e.parameter;
    } else {
      throw new Error("No valid request data found");
    }
    
    const action = params.action;

    // --- PHOTO UPLOAD HANDLER ---
    if (action === "uploadPhoto") {
      const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
      
      // Validate required fields
      if (!params.fileName) throw new Error("Missing fileName");
      if (!params.mimeType) throw new Error("Missing mimeType");
      if (!params.data) throw new Error("Missing data");
      
      // Create timestamp for unique filename
      const timestamp = new Date().getTime();
      const uniqueFileName = `client_photo_${timestamp}_${params.fileName}`;
      
      // Decode base64 to byte array
      const decodedBytes = Utilities.base64Decode(params.data);
      
      // Create blob directly from byte array
      const blob = Utilities.newBlob(decodedBytes, params.mimeType, uniqueFileName);
      
      // Create file in Drive folder
      const file = folder.createFile(blob);
      const fileId = file.getId();
      
      // Set sharing to anyone with link
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      
      // Use thumbnail URL instead - works better for public files
      const url = `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`;
      
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        url: url,
        fileId: fileId,
        fileName: uniqueFileName
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // --- ADD/EDIT CLIENT DATA ---
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheetName = params.sheetName;
    const sheet = ss.getSheetByName(sheetName);
    let rowData = typeof params.data === 'string' ? JSON.parse(params.data) : params.data;

    if (action === "add") {
      sheet.appendRow(rowData);
    } else if (action === "edit") {
      const rowNumber = parseInt(params.rowNumber);
      sheet.getRange(rowNumber, 1, 1, rowData.length).setValues([rowData]);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: "Data saved successfully"
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  } finally { 
    lock.releaseLock(); 
  }
}
